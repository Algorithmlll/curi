<!doctype html>
<html>
  <head>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tutorial Part 7: The Load Function | Curi Documentation</title>
    <link href="https://fonts.googleapis.com/css?family=Zilla+Slab:300,400" rel="stylesheet">
    <link href="/static/css/index.css" rel="stylesheet">
  </head>
  <body>
    <div id="root"><div data-reactroot=""><header><nav><ul><li><a class="home-link" href="/">Curi</a></li><li><a href="/packages">Packages</a></li><li><a href="/tutorial/01-introduction">Tutorial</a></li><li><a href="/guides/getting-started/">Guides</a></li><li><a href="/examples">Examples</a></li><li><a href="https://github.com/pshrmn/curi">GitHub</a></li></ul></nav></header><main><div class="tutorial"><div class="content"><h1>Part 7: The Load Function</h1><p>In the previous tutorial, we wrote mocked book data in <code class="language-javascript">books.js</code> <!-- --> to have some data to load, but it was just filler data. We just imported the data as an array, whereas in a &quot;real&quot; website, we would most likely make a request to our server which would return our data (possibly after running a database query).</p><div><p>In this tutorial, we will be doing the following:</p><ul><li>Writing a fake API to simulate data requests.</li><li>Adding <code class="language-javascript">load</code> functions to our &quot;Book List&quot; and &quot;Book&quot; routes.</li></ul></div><div class="section"><h2 id="api">Fake API<a class="header-link" href="/tutorial/07-load#api">#</a></h2><p>There are a number of ways that we might make a request to the server, but in this tutorial   we will simulate using the<!-- --> <a href="https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API">Fetch API</a>.<!-- --> <!-- -->The <code class="language-javascript">fetch</code> function makes a request to the server and returns a Promise that will resolve with the server&#x27;s response.</p><p>Let&#x27;s create an <code class="language-javascript">api</code> directory and start writing our fake fetch functions.</p><pre class="language-bash">mkdir -p src/api
touch src/api/books.js</pre><p>We&#x27;ll need to write two functions. The first will fetch all of our books and the second will fetch a specific book given an <code class="language-javascript">id</code>. Since we are emulating how <code class="language-javascript">fetch</code> works, both of our functions should return a Promise.</p><pre class="language-javascript">// api/books.js
export function fetchAllBooks() {
  return new Promise((resolve, reject) =&gt; {

  });
}

export function fetchBook(id) {
  return new Promise((resolve, reject) =&gt; {
  
  });
}</pre><p>We need some actual data for our fetch functions to return, so let&#x27;s write an array of book objects. You can make up your own data or just copy the list from below.</p><pre class="language-javascript">// api/books.js
const books = [
  {
    id: 0,
    title: &#x27;Harry Potter and the Deathly Hollows&#x27;,
    author: &#x27;J.K. Rowling&#x27;,
    published: &#x27;2007&#x27;,
    pages: 759
  },
  {
    id: 1,
    title: &#x27;The Name of the Wind&#x27;,
    author: &#x27;Patrick Rothfuss&#x27;,
    published: &#x27;2007&#x27;,
    pages: 662
  },
  {
    id: 2,
    title: &quot;The Wise Man&#x27;s Fear&quot;,
    author: &#x27;Patrick Rothfuss&#x27;,
    published: &#x27;2011&#x27;,
    pages: 994
  },
  {
    id: 3,
    title: &#x27;The Way of Kings&#x27;,
    author: &#x27;Brandon Sanderson&#x27;,
    published: &#x27;2010&#x27;,
    pages: 1007
  },
  {
    id: 4,
    title: &#x27;A Storm of Swords&#x27;,
    author: &#x27;George R.R. Martin&#x27;,
    published: &#x27;2003&#x27;,
    pages: 1177
  },
  {
    id: 5,
    title: &#x27;Clockwork Princess&#x27;,
    author: &#x27;Cassandra Clare&#x27;,
    published: &#x27;2013&#x27;,
    pages: 567
  },
  {
    id: 6,
    title: &#x27;Words of Radiance&#x27;,
    author: &#x27;Brandon Sanderson&#x27;,
    published: &#x27;2014&#x27;,
    pages: 1087
  },
  {
    id: 7,
    title: &#x27;Collected Fictions&#x27;,
    author: &#x27;Jorge Luis Borges&#x27;,
    published: &#x27;1999&#x27;,
    pages: 565
  },
  {
    id: 8,
    title: &#x27;Heir of Fire&#x27;,
    author: &#x27;Sarah J. Maas&#x27;,
    published: &#x27;2014&#x27;,
    pages: 565
  },
  {
    id: 9,
    title: &#x27;The House of Hades&#x27;,
    author: &#x27;Rick Riordan&#x27;,
    published: &#x27;2013&#x27;,
    pages: 597
  }
];</pre><p>With this data, we can now finish our data fetching functions. Our <code class="language-javascript">fetchAllBooks</code> function should just resolve with the books array. <code class="language-javascript">fetchBook</code> should search the books array for the book with the requested id. If it finds a matching book object, the function should resolve with that book object. If the requested book is not found, it should reject with an error message.</p><pre class="language-javascript">// api/books.js
const books = [...];

export function fetchAllBooks() {
  return new Promise((resolve, reject) =&gt; {
    resolve(books);
  });
}

export function fetchBook(id) {
  return new Promise((resolve, reject) =&gt; {
    const book = books.find(book =&gt; book.id === id);
    if (book) {
      resolve(book);
    } else {
      reject(`Could not find the requested book: ${id}`);
    }
  });
}</pre></div><div class="section"><h2 id="load">route.load<a class="header-link" href="/tutorial/07-load#load">#</a></h2><p>Do you remember before when we said that Curi is an asynchronous router? Now is the time that we finally will see why.</p><p>Each route can have a <code class="language-javascript">load</code> property. This is a function that can perform data loading related to a route prior to emitting a response. We can use the <code class="language-javascript">load</code> function to modify the response or to update some other code like a global data store.</p><pre class="language-javascript">{
  name: &#x27;Book List&#x27;,
  path: &#x27;books&#x27;,
  load: function() {
    // ...
  }
}</pre><div class="aside"><h3 id="load-arguments">Load Arguments<a class="header-link" href="/tutorial/07-load#load-arguments">#</a></h3><p>In order to load data/modify the response, <code class="language-javascript">load</code> functions need to receive a few arguments.</p><pre class="language-javascript">{
    name: &#x27;Book&#x27;,
    load: (route, mods, addons) =&gt; {
      const { params, location, name } = route;
      const { setData, redirect, fail, setStatus } = mods;
      const { pathname, ...rest } = addons;   
    }
  }</pre><p>The first argument that will be passed to your load function is an object with properties related to the matched route. These are <code class="language-javascript">params</code>, which is the object of path params parsed from the location&#x27;s pathname,<!-- --> <code class="language-javascript">location</code>, which is the location object used to match the route, and <code class="language-javascript">name</code>, which is the name of the matched route.</p><p>The second argument that will be passed to your load function is an object whose properties are functions that you can use to modify the response object. These functions are <code class="language-javascript">setData</code>, <code class="language-javascript">redirect</code>, <code class="language-javascript">setStatus</code>, and <code class="language-javascript">fail</code>. The<!-- --> <a href="/guides/routes/#load">All About Routes</a> guide goes into detail about all four of those. For this tutorial, we will only be using <code class="language-javascript">setData</code>.</p><p>The third, and final, argument that will be passed to your load function is an object containing all of the Curi addons that are registered with your Curi configuration object. This includes the <code class="language-javascript">pathname</code> addon, which you may find useful for generating pathnames in your <code class="language-javascript">load</code> (particularly if you plan to use the <code class="language-javascript">redirect</code> function mentioned above).</p></div><div class="aside"><h3 id="load-return">Load Return Value<a class="header-link" href="/tutorial/07-load#load-return">#</a></h3><p><code class="language-javascript">load</code> functions are expected to return a Promise. Curi uses<!-- --> <code class="language-javascript">Promise.all</code> to wait for your <code class="language-javascript">load</code> function to resolve before it emits a response. Technically speaking, your <code class="language-javascript">load</code> function does not have to return a Promise, but it is recommended.</p><pre class="language-javascript">{
  load: (route, mods, addons) =&gt; {
    return fetch(`/api/book/${route.params.id}`)
      .then(resp =&gt; {...});
  }
}</pre></div><p>We have two routes to add load functions to: &quot;Book List&quot; and &quot;Book&quot;. Let&#x27;s start by having each one call their respective API functions that we defined above.</p><pre class="language-javascript">// routes.js
import { fetchAllBooks, fetchBook } from &#x27;./api/books&#x27;;
const routes = [
  // ...,
  {
    name: &#x27;Book List&#x27;,
    path: &#x27;books&#x27;,
    body: () =&gt; BookList,
    load: (route, response, addons) =&gt; {
      return fetchAllBooks();
    },
    children: [
      {
        name: &#x27;Book&#x27;,
        path: &#x27;:id&#x27;,
        body: () =&gt; Book,
        params: { id: n =&gt; parseInt(n, 10) },
        load: (route, response, addons) =&gt; {
          return fetchBook(route.params.id);
        }
      }
    ]
  },
  // ...
];</pre><div class="note"><strong>Note:</strong> <!-- -->In the above &quot;Book&quot; route, we introduce the <code class="language-javascript">route.params</code> <!-- -->property. This is an object whose keys are path param names and whose values are functions that will parse the param string to return a new value. For example, the above function takes the input string and returns that string parsed as an integer.</div><p>If the only thing that our <code class="language-javascript">load</code> functions do is return a Promise, they aren&#x27;t particularly useful. Instead, we need to use the results of our fetch functions to call the<!-- --> <code class="language-javascript">setData</code> function that is provided by the second argument to our load function. <code class="language-javascript">setData</code> takes an object and will add that object to the response object as its <code class="language-javascript">data</code> property. Let&#x27;s add <code class="language-javascript">then</code> callback functions to our fetches to do this.</p><pre class="language-javascript">// routes.js
import { fetchAllBooks, fetchBook } from &#x27;./api/books&#x27;;
const routes = [
  // ...,
  {
    name: &#x27;Book List&#x27;,
    path: &#x27;books&#x27;,
    body: () =&gt; BookList,
    load: (route, response, addons) =&gt; {
      return fetchAllBooks()
        .then(books =&gt; {
          response.setData({ books });
        });
    },
    children: [
      {
        name: &#x27;Book&#x27;,
        path: &#x27;:id&#x27;,
        body: () =&gt; Book,
        params: { id: n =&gt; parseInt(n, 10) },
        load: (route, response, addons) =&gt; {
          return fetchBook(route.params.id)
            .then(
              book =&gt; {
                response.setData({ book });
              },
              err =&gt; {
                console.error(err);
              }
            );
        }
      }
    ]
  },
  // ...
];</pre><div class="note"><strong>Note:</strong> <!-- -->You are responsible for catching any errors within your<!-- --> <code class="language-javascript">load</code> function. If you do not, they can be swallowed and cause unexpected errors in your website.</div><p>Now, when a user visits <code class="language-javascript">/books</code>, the response generated by Curi will look like this:</p><pre class="language-javascript">{
  name: &#x27;Book List&#x27;,
  data: {
    books: [/*...*/]
  },
  // ...
}</pre><p>Likewise, visiting <code class="language-javascript">/books/0</code> will generate a response whose<!-- --> <code class="language-javascript">data</code> property is a book object.</p><pre class="language-javascript">{
  name: &#x27;Book&#x27;,
  params: { id: 0 }
  data: {
    book: { title: &#x27;...&#x27;, /*...*/ }
  },
  // ...
}</pre></div><div class="section"><h2 id="next">Next<a class="header-link" href="/tutorial/07-load#next">#</a></h2><p>Now that we are loading data for our routes, we should modify our &quot;Book List&quot; and &quot;Book&quot; pages to render using this data. Once again, we will break this down for React and Vue users.</p><p>If you are using React, continue with<!-- --> <a href="/tutorial/08-render-data-react">Part 8: Rendering Data with React</a>.</p><p>If you are using Vue, continue with<!-- --> <a href="/tutorial/08-render-data-vue">Part 8: Rendering Data with Vue</a>.</p></div></div><div class="sidebar"><h2>Tutorials</h2><ul class="link-list"><li class="solo"><a href="/tutorial/01-introduction">Part 1: Introduction to Curi</a></li><li class="solo"><a href="/tutorial/02-setup">Part 2: Curi Setup</a></li><li class="solo"><a href="/tutorial/03-routes">Part 3: Curi Routes</a></li><li class="solo"><a href="/tutorial/04-hickory">Part 4: Hickory</a></li><li class="solo"><a href="/tutorial/05-config">Part 5: The Curi Configuration Object</a></li><li class="solo"><p>Part 6: Rendering Pages</p><ul class="frameworks"><li><a href="/tutorial/06-pages-react">react</a></li><li><a href="/tutorial/06-pages-vue">vue</a></li></ul></li><li class="solo"><a class="active" href="/tutorial/07-load">Part 7: The Load Function</a></li><li class="solo"><p>Part 8: Rendering Data</p><ul class="frameworks"><li><a href="/tutorial/08-render-data-react">react</a></li><li><a href="/tutorial/08-render-data-vue">vue</a></li></ul></li><li class="solo"><p>Part 9: Forms &amp; Programmatic Navigation</p><ul class="frameworks"><li><a href="/tutorial/09-nav-react">react</a></li><li><a href="/tutorial/09-nav-vue">vue</a></li></ul></li><li class="solo"><a href="/tutorial/10-now-what">Part 10: Now What?</a></li></ul></div></div></main></div></div>
    <script src="https://unpkg.com/react@16.0.0/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.0.0/umd/react-dom.production.min.js"></script>
    <script src="/static/js/prism.js"></script>
    <script src="/static/js/bundle.js"></script>
  </body>
</html>
